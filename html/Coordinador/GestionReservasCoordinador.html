<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CIIT</title>
    <link rel="stylesheet" href="../../css/NavBar.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <style>
      /* ---- Ajustes visuales de esta vista (sin tocar NavBar.css) ---- */
        .contenedor-pagina {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background: var(--color-fondo);
            border-radius: 16px;
            box-shadow: var(--sombra-suave);
            padding: 1rem;
        }

        /* etiquetas de horas un poco más pequeñas */
        #calendario-admin .fc .fc-timegrid-axis-cushion,
        #calendario-admin .fc .fc-timegrid-slot-label-cushion { font-size: .85rem; }
        /* Calendario más pequeño y legible */
        #calendario-admin { margin-bottom: 1.25rem; }
        /* Calendario más angosto y centrado */
        #calendario-admin {
            max-width: 950px;      /* ajusta a gusto: 900, 1000, lo que te acomode */
            margin: 0 auto 1.25rem;  /* centra horizontalmente + margen abajo */
        }

        #calendario-admin .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 700; }
      
        #calendario-admin .fc .fc-button { border-radius: 10px; padding: .25rem .6rem; }

        /* Forzar que el timeGrid NO use scroll interno */
        #calendario-admin .fc .fc-scroller {
            overflow: visible !important;
        }

        /* Quitar el fondo amarillo chillón cuando la vista es SOLO por día */
        #calendario-admin .fc-timeGridDay-view .fc-day-today,
        #calendario-admin .fc-timeGridDay-view .fc-timegrid-col.fc-day-today,
        #calendario-admin .fc-timeGridDay-view .fc-timegrid-col.fc-day-today .fc-timegrid-col-frame {
            background: transparent !important;
        }

        /* Eventos clicables en el calendario: mostrar mano */
        #calendario-admin .fc .fc-event,
        #calendario-admin .fc .fc-timegrid-event,
        #calendario-admin .fc .fc-timegrid-event-harness {
            cursor: pointer;
        }



        /* Lista de solicitudes */
        .solicitudes-wrap {
            margin-top: 1.25rem;
        }
        
        /* Contenedor scroll horizontal si alguna columna se pasa */
        .tabla-solicitudes-wrap {
            margin-top: 0.5rem;
            border-radius: 14px;
            box-shadow: var(--sombra-suave);
            background: var(--color-fondo);
            overflow: hidden;
        }

        /* Tabla “lista” */
        .tabla-solicitudes {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        /* Cabecera fija y con fondo */
        .tabla-solicitudes thead {
            background: #f5f7fb;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .tabla-solicitudes th,
        .tabla-solicitudes td {
            padding: 0.6rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--color-gris);
            vertical-align: middle;
        }

        .tabla-solicitudes th {
            font-weight: 600;
            color: #4b5563;
            white-space: nowrap;
        }

        .tabla-solicitudes tbody tr:hover {
            background: rgba(48, 127, 226, 0.04);
        }

        /* Filas clicables en la tabla de solicitudes */
        .tabla-solicitudes tbody tr {
            cursor: pointer;
        }

        /* Celda de acciones en fila */
        .acciones-solicitud {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        /* Ajuste de chips dentro de la tabla */
        .chip {
            font-size: 0.78rem;
            border-radius: 999px;
            padding: 0.15rem 0.55rem;
            border: 1px solid var(--color-gris);
            background: #fff;
            display: inline-block;
        }

        /* Modo oscuro para la tabla */
        body.tema-oscuro .tabla-solicitudes-wrap {
            background: #1f2937;
        }

        body.tema-oscuro .tabla-solicitudes thead {
            background: #111827;
        }

        body.tema-oscuro .tabla-solicitudes th {
            color: #e5e7eb;
        }

        body.tema-oscuro .tabla-solicitudes td {
            border-bottom-color: rgba(249, 250, 251, 0.06);
        }

        
        .solicitud-titulo {
            font-weight: 700;
            color: var(--color-primario);
            font-size: 1.05rem;
        }
        .chip {
            font-size: .78rem;
            border-radius: 999px;
            padding: .25rem .6rem;
            border: 1px solid var(--color-gris);
            background: #fff;
        }
        .chip.pendiente { background: #fff9e6; border-color: #ffe08a; color: #916c00; }
        .chip.aceptada { background: #e9f8ed; border-color: #b9e5c4; color: #196c3f; }
        .chip.rechazada { background: #fdeaea; border-color: #f5bcbc; color: #8d2727; }
        
        .acciones-solicitud {
            display: flex; gap: .5rem; margin-top: .25rem;
        }
        .btn {
            border: none; border-radius: 10px; padding: .55rem .8rem; cursor: pointer; font-weight: 600;
            box-shadow: var(--sombra-suave);
        }
        .btn-aceptar { background: var(--color-primario); color: #fff; }
        .btn-aceptar:hover { background: #2368b8; }
        .btn-rechazar {
            background: transparent; color: var(--color-primario);
            border: 1px solid var(--color-primario);
        }
        .btn-rechazar:hover { background: var(--color-primario); color: #fff; }
        .btn:disabled { opacity: .6; cursor: not-allowed; }

        /* Título secciones */
        .seccion-titulo {
            color: #0b1f3a; font-weight: 700; margin: .5rem 0 1rem;
        }

      /* Mejor contraste en modo oscuro del calendario */
        body.tema-oscuro #calendario-admin .fc{
            --fc-neutral-bg-color: #152238;        /* fondo de grilla */
            --fc-page-bg-color: transparent;
            --fc-border-color: rgba(255,255,255,.08);
            --fc-today-bg-color: rgba(48,127,226,.15);
        }

      /* Dark mode hereda de NavBar.css: body.tema-oscuro ... */
        body.tema-oscuro .card,
        body.tema-oscuro .solicitud-card { background: #1f2937; }
        body.tema-oscuro .solicitud-meta { color: #d1d5db; }
        body.tema-oscuro .seccion-titulo { color: #e5eefc; }

        /* ===== Modal de detalle de solicitud ===== */
        .overlay-detalle {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .overlay-detalle.activo {
            display: flex;
        }

        .detalle-card {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 20px 45px rgba(0,0,0,0.25);
            max-width: 520px;
            width: 90%;
            padding: 1.5rem 1.75rem;
            position: relative;
        }

        .detalle-card h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #0b1f3a;
        }

        .detalle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .5rem 1.25rem;
            font-size: .9rem;
        }

        .detalle-grid strong {
            display: block;
            font-weight: 600;
            color: #4b5563;
        }

        .detalle-nota {
            margin-top: .75rem;
            font-size: .88rem;
            color: #4b5563;
        }

        .detalle-cerrar {
            position: absolute;
            top: .6rem;
            right: .6rem;
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            line-height: 1;
        }

        /* Modo oscuro para el modal */
        body.tema-oscuro .detalle-card {
            background: #1f2937;
            color: #e5e7eb;
        }

        body.tema-oscuro .detalle-card h3 {
            color: #e5eefc;
        }

        body.tema-oscuro .detalle-grid strong {
            color: #e5e7eb;
        }

        body.tema-oscuro .detalle-nota {
            color: #d1d5db;
        }

    </style>
</head>

<!-- nota: esta vista es admin, para oscurecer SOLO este navbar -->
<body data-vista="espacios" data-rol="admin">
    <header class="barra-superior">
        <div class="logo">
            <span class="logo-simbolo">CIIT</span>
            <span class="logo-texto">Area de informatica</span>
        </div>
        <nav class="menu-principal">
            <a href="../views/home.html" data-link="home">Inicio</a>
            <a href="../views/perfil.html" data-link="perfil">Perfil</a>
            <a href="../views/inventario.html" data-link="inventario">Inventario</a>
            <a href="../views/reservas.html" data-link="reservas" class="activo">Gestión de reservas</a>
            <a href="../views/reportes.html" data-link="reportes">Gestión de artículos</a>
        </nav>

        <div class="acciones-header">
            <label class="interruptor-tema" aria-label="Cambiar tema">
                <input type="checkbox" id="interruptorTema" />
                <span class="slider"></span>
            </label>
            <span id="nombreUsuarioActivo" class="usuario-activo"></span>
        </div>
    </header>

    <main class="contenedor-pagina">
      <!-- Calendario de reservas -->
      <section id="calendario-admin" class="card" aria-label="Calendario de reservas">
        <h2 class="seccion-titulo">Calendario de reservas CITT</h2>
        <div id="calendar"></div>
      </section>

      <section class="solicitudes-wrap">
    <h2 class="seccion-titulo">Solicitudes de reserva pendientes</h2>

    <div class="tabla-solicitudes-wrap">
        <table class="tabla-solicitudes" aria-label="Solicitudes de reserva pendientes">
        <thead>
            <tr>
            <th>Espacio</th>
            <th>Fecha</th>
            <th>Horario</th>
            <th>Solicitante</th>
            <th>Detalle</th>
            <th>Estado</th>
            <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaSolicitudes"></tbody>
        </table>
    </div>
    </section>

        <!-- Modal detalle de solicitud -->
    <div id="overlayDetalle" class="overlay-detalle" aria-hidden="true">
      <div class="detalle-card" role="dialog" aria-modal="true" aria-labelledby="detalleTitulo">
        <button type="button" class="detalle-cerrar" id="btnCerrarDetalle" aria-label="Cerrar detalle">&times;</button>
        <h3 id="detalleTitulo">Detalle de la solicitud</h3>
        <div id="detalleContenido"></div>
      </div>
    </div>


    </main>

    <!-- Scripts FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>

    <script>
      // Colores por espacio / exclusividad
      const COLOR_EVENTOS = {
        // por espacio
        "Sala de reuniones": "#10b981",       // verde
        "Cápsula A": "#3b82f6",              // azul
        "Sala CIIT completa": "#f97316",     // naranjo

        // fallback
        "_default": "#307FE2",

        // si es exclusivo, este manda
        "_exclusivo": "#e11d48"              // rojo fuerte
      };

      // ---------- Tema oscuro persistente ----------
      const interruptorTema = document.getElementById("interruptorTema");
      if (localStorage.getItem("tema") === "oscuro") {
        document.body.classList.add("tema-oscuro");
        interruptorTema.checked = true;
      }
      interruptorTema.addEventListener("change", () => {
        if (interruptorTema.checked) {
          document.body.classList.add("tema-oscuro");
          localStorage.setItem("tema", "oscuro");
        } else {
          document.body.classList.remove("tema-oscuro");
          localStorage.setItem("tema", "claro");
        }
      });

      // ---------- Datos mock de calendario y solicitudes ----------
        const EVENTS_LS_KEY = "citt_eventos_aprobados";
        const eventosAprobados = JSON.parse(localStorage.getItem(EVENTS_LS_KEY) || "{}");


      const eventosMock = [
      {
        id: "e1",
        title: "Reserva Sala 1 - Taller",
        start: "2025-11-06T10:00:00",
        end: "2025-11-06T12:00:00",
        espacio: "Sala de reuniones",
        exclusivo: false,
        solicitante: "demo@duocuc.cl",
        personas: 10,
        articulos: ["Proyector"],
        detalle: "Actividad demo cargada por defecto"
      },
      {
        id: "e2",
        title: "Cápsula A - Edición",
        start: "2025-11-07T14:00:00",
        end: "2025-11-07T15:00:00",
        espacio: "Cápsula A",
        exclusivo: false,
        solicitante: "demo2@duocuc.cl",
        personas: 3,
        articulos: ["Micrófono", "Cámara"],
        detalle: "Prueba de edición en cápsula"
      }
    ];



      // Persistencia simple para estado de solicitudes en mock
      const ESTADOS_LS_KEY = "citt_estados_solicitudes";
      const estadosPersistidos = JSON.parse(localStorage.getItem(ESTADOS_LS_KEY) || "{}");

        const solicitudesMock = [
        {
          id: "s1",
          titulo: "Sala de reuniones",
          solicitante: "jperez@duocuc.cl",
          fecha: "2025-11-08",
          inicio: "09:30",
          fin: "11:00",
          espacio: "Sala de reuniones",
          detalle: "Reunión proyecto IoT",
          personas: 8,
          exclusivo: false, // solo una sección
          articulos: ["Proyector", "Notebook (2)"],
          eventoRef: null
        },
        {
          id: "s2",
          titulo: "Cápsula A (streaming)",
          solicitante: "mrojas@duocuc.cl",
          fecha: "2025-11-08",
          inicio: "12:00",
          fin: "13:00",
          espacio: "Cápsula A",
          detalle: "Grabación cápsula Clase 6",
          personas: 3,
          exclusivo: false,
          articulos: ["Micrófonos inalámbricos (2)"],
          eventoRef: null
        },
        {
          id: "s3",
          titulo: "Sitio personal 3",
          solicitante: "florente@duocuc.cl",
          fecha: "2025-11-09",
          inicio: "15:00",
          fin: "17:30",
          espacio: "Sala CIIT completa",
          detalle: "Prototipo impresión 3D",
          personas: 15,
          exclusivo: true, // pide exclusividad
          articulos: ["Impresora 3D", "Notebook", "Cámara"],
          eventoRef: null
        }
      ].map(s => ({ ...s, estado: estadosPersistidos[s.id] || "pendiente" }));


      // ---------- Calendario ----------
      document.addEventListener("DOMContentLoaded", function() {
        const calendarEl = document.getElementById("calendar");
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 800 ? "timeGridDay" : "timeGridWeek",
          locale: "es",
          buttonText: {
            today: "Hoy",
            timeGridWeek: "Semana", // o "semana"
            timeGridDay:  "Día"     // o "día"
          },
          expandRows: true,
          height: "auto",          // <– clave: sin altura fija
          contentHeight: "auto",   // opcional, ayuda a que crezca
          nowIndicator: true,
          slotDuration: "00:30:00",
          snapDuration: "00:15:00",
          slotMinTime: "08:00:00",
          slotMaxTime: "23:00:00",
          allDaySlot: false,
          selectable: true,
          selectMirror: true,
          dayMaxEventRows: 3,
          eventOverlap: false,
          headerToolbar: { left: "prev,next today", center: "title", right: "timeGridWeek,timeGridDay" },
          events: eventosMock,
          eventDidMount: (info) => {
            const { espacio, exclusivo } = info.event.extendedProps || {};

            let color;

            if (exclusivo) {
              color = COLOR_EVENTOS["_exclusivo"];
            } else if (espacio && COLOR_EVENTOS[espacio]) {
              color = COLOR_EVENTOS[espacio];
            } else {
              color = COLOR_EVENTOS["_default"];
            }

            // Pintar el bloque entero
            const el = info.el;
            el.style.backgroundColor = color;
            el.style.borderColor = color;
            el.style.color = "#ffffff"; // texto blanco para contraste
          },
          eventClick: (info) => {
          const ev  = info.event;
          const ext = ev.extendedProps || {};

          // Si viene de una solicitud aprobada, usamos la solicitud original
          if (ext.solicitud) {
            abrirDetalle(ext.solicitud);
            return;
          }

          // Si es un evento "sueltito" (eventosMock, etc.), armamos un objeto tipo solicitud
          const start = ev.start;
          const end   = ev.end || ev.start;

          const pad = (n) => String(n).padStart(2, "0");

          const fecha = `${start.getFullYear()}-${pad(start.getMonth() + 1)}-${pad(start.getDate())}`;
          const inicio = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
          const fin = `${pad(end.getHours())}:${pad(end.getMinutes())}`;

          const solFake = {
            titulo: ev.title,
            espacio: ext.espacio || ev.title,
            fecha,
            inicio,
            fin,
            solicitante: ext.solicitante || "No indicado",
            personas: ext.personas != null ? ext.personas : "No indicado",
            exclusivo: ext.exclusivo || false,
            articulos: ext.articulos || [],
            detalle: ext.detalle || ""
          };

          abrirDetalle(solFake);
        },

          // solo cambiamos la vista según ancho, ya NO tocamos height
          windowResize: () => {
            calendar.changeView(
              window.innerWidth < 800 ? "timeGridDay" : "timeGridWeek"
             );
          }
        });

        calendar.render();

                // ----- Modal detalle -----
        const overlayDetalle   = document.getElementById("overlayDetalle");
        const detalleContenido = document.getElementById("detalleContenido");
        const btnCerrarDetalle = document.getElementById("btnCerrarDetalle");

        const abrirDetalle = (sol) => {
          const exclusividadTexto = sol.exclusivo
            ? "Sí, uso exclusivo de la sala CIIT"
            : "No, solo una sección / espacio específico";

          const articulosTexto = sol.articulos && sol.articulos.length
            ? sol.articulos.join(", ")
            : "Sin artículos asociados";

          detalleContenido.innerHTML = `
            <div class="detalle-grid">
              <div>
                <strong>Espacio</strong>
                <span>${sol.espacio || sol.titulo}</span>
              </div>
              <div>
                <strong>Fecha</strong>
                <span>${sol.fecha}</span>
              </div>
              <div>
                <strong>Horario</strong>
                <span>${sol.inicio} - ${sol.fin}</span>
              </div>
              <div>
                <strong>Solicitante</strong>
                <span>${sol.solicitante}</span>
              </div>
              <div>
                <strong>N° de personas</strong>
                <span>${sol.personas || "No indicado"}</span>
              </div>
              <div>
                <strong>Exclusividad</strong>
                <span>${exclusividadTexto}</span>
              </div>
            </div>
            <div class="detalle-nota">
              <strong>Artículos solicitados:</strong><br/>
              <span>${articulosTexto}</span>
            </div>
            <div class="detalle-nota">
              <strong>Detalle adicional:</strong><br/>
              <span>${sol.detalle || "Sin detalle adicional"}</span>
            </div>
          `;

          overlayDetalle.classList.add("activo");
          overlayDetalle.setAttribute("aria-hidden", "false");
        };

        const cerrarDetalle = () => {
          overlayDetalle.classList.remove("activo");
          overlayDetalle.setAttribute("aria-hidden", "true");
        };

        btnCerrarDetalle.addEventListener("click", cerrarDetalle);

        // Cerrar al hacer click fuera de la tarjeta
        overlayDetalle.addEventListener("click", (e) => {
          if (e.target === overlayDetalle) cerrarDetalle();
        });

        // Cerrar con ESC
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") cerrarDetalle();
        });


        Object.values(eventosAprobados).forEach(evt => calendar.addEvent(evt));


        // ---------- Renderizar solicitudes debajo (en tabla) ----------
        const cont = document.getElementById("listaSolicitudes"); // <tbody>

        const renderChip = (estado) => {
        const span = document.createElement("span");
        span.className = `chip ${estado}`;
        span.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
        return span;
        };

        const guardarEstado = (id, estado) => {
        estadosPersistidos[id] = estado;
        localStorage.setItem(ESTADOS_LS_KEY, JSON.stringify(estadosPersistidos));
        };

        const manejarAccion = (sol, accion, chip, btnAceptar, btnRechazar) => {
        const startISO = `${sol.fecha}T${sol.inicio}:00`;
        const endISO   = `${sol.fecha}T${sol.fin}:00`;

        const haySolape = () => {
            const s = new Date(startISO).getTime();
            const e = new Date(endISO).getTime();
            return calendar.getEvents().some(ev => {
            const es = ev.start?.getTime() ?? 0;
            const ee = ev.end?.getTime() ?? es;
            return Math.max(s, es) < Math.min(e, ee);
            });
        };

        if (accion === "aceptar") {
          if (haySolape() && !confirm("Conflicto con otra reserva. ¿Forzar aceptación igualmente?")) {
            return;
          }
          sol.estado = "aceptada";

          const evt = {
            id: `aprob-${sol.id}`,
            title: `${sol.espacio} - ${sol.solicitante.split("@")[0]}`,
            start: startISO,
            end: endISO,
            espacio: sol.espacio,
            exclusivo: sol.exclusivo,
            // guardamos la solicitud completa para el modal
            solicitud: { ...sol }
          };

          calendar.addEvent(evt);
          eventosAprobados[sol.id] = evt;
          localStorage.setItem(EVENTS_LS_KEY, JSON.stringify(eventosAprobados));
        } else {
            sol.estado = "rechazada";
            const ev = calendar.getEventById(`aprob-${sol.id}`);
            if (ev) ev.remove();
            delete eventosAprobados[sol.id];
            localStorage.setItem(EVENTS_LS_KEY, JSON.stringify(eventosAprobados));
        }

        // UI
        chip.className = `chip ${sol.estado}`;
        chip.textContent = sol.estado.charAt(0).toUpperCase() + sol.estado.slice(1);
        btnAceptar.disabled = true;
        btnRechazar.disabled = true;
        guardarEstado(sol.id, sol.estado);
        };

        solicitudesMock.forEach(sol => {
          const tr = document.createElement("tr");

          const tdEspacio = document.createElement("td");
          tdEspacio.textContent = sol.espacio || sol.titulo;

          const tdFecha = document.createElement("td");
          tdFecha.textContent = sol.fecha;

          const tdHorario = document.createElement("td");
          tdHorario.textContent = `${sol.inicio} - ${sol.fin}`;

          const tdSolicitante = document.createElement("td");
          tdSolicitante.textContent = sol.solicitante;

          const tdDetalle = document.createElement("td");
          tdDetalle.textContent = sol.detalle;

          const tdEstado = document.createElement("td");
          const chip = renderChip(sol.estado);
          tdEstado.appendChild(chip);

          const tdAcciones = document.createElement("td");
          tdAcciones.className = "acciones-solicitud";

          const btnAceptar = document.createElement("button");
          btnAceptar.className = "btn btn-aceptar";
          btnAceptar.textContent = "Aceptar";

          const btnRechazar = document.createElement("button");
          btnRechazar.className = "btn btn-rechazar";
          btnRechazar.textContent = "Rechazar";

          if (sol.estado !== "pendiente") {
              btnAceptar.disabled = true;
              btnRechazar.disabled = true;
          }

          tr.addEventListener("click", () => {
            abrirDetalle(sol);
          });

          // Evitar que los botones disparen también el click de la fila
          btnAceptar.addEventListener("click", (e) => {
              e.stopPropagation();
              manejarAccion(sol, "aceptar", chip, btnAceptar, btnRechazar);
          });

          btnRechazar.addEventListener("click", (e) => {
              e.stopPropagation();
              manejarAccion(sol, "rechazar", chip, btnAceptar, btnRechazar);
          });


          tdAcciones.appendChild(btnAceptar);
          tdAcciones.appendChild(btnRechazar);

          tr.appendChild(tdEspacio);
          tr.appendChild(tdFecha);
          tr.appendChild(tdHorario);
          tr.appendChild(tdSolicitante);
          tr.appendChild(tdDetalle);
          tr.appendChild(tdEstado);
          tr.appendChild(tdAcciones);

          cont.appendChild(tr);
        });


      });
    </script>
</body>
</html>
