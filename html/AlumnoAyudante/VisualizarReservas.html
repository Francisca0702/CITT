<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CITT - Visualizar Reservas</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    
    <link rel="stylesheet" href="../../../css/AlumnoAyudanteVerReserva.css">
    
    
</head>

<body data-vista="ayudante-visualizar">

    <iframe 
        src="./NavBarAlumnoAyudante.html"
        style="width:100%; height:100px; border:none;"
        title="Navbar Alumno Ayudante">
    </iframe>

    <main class="contenedor-pagina">
      <section id="calendario-admin" class="card" aria-label="Calendario de reservas">
        <h2 class="seccion-titulo">Calendario de reservas CITT</h2>
        <div id="calendar"></div>
      </section>

      <section class="solicitudes-wrap">
        <h2 class="seccion-titulo">Solicitudes de reserva</h2>

        <div class="tabla-solicitudes-wrap">
            <table class="tabla-solicitudes" aria-label="Solicitudes de reserva">
            <thead>
                <tr>
                  <th>Espacio</th>
                  <th>Fecha</th>
                  <th>Horario</th>
                  <th>Solicitante</th>
                  <th>Detalle</th>
                  <th>Estado</th>
                </tr>
            </thead>
            <tbody id="listaSolicitudes"></tbody>
            </table>
        </div>
      </section>

      <div id="overlayDetalle" class="overlay-detalle" aria-hidden="true">
      <div class="detalle-card" role="dialog" aria-modal="true" aria-labelledby="detalleTitulo">
        <button type="button" class="detalle-cerrar" id="btnCerrarDetalle" aria-label="Cerrar detalle">&times;</button>
        <h3 id="detalleTitulo">Detalle de la solicitud</h3>
        <div id="detalleContenido"></div>
      </div>
    </div>


    </main>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>

    <script>
      // Colores (igual que el coordinador)
      const COLOR_EVENTOS = {
        "Sala de reuniones": "#10b981",
        "Cápsula A": "#3b82f6",
        "Sala CIIT completa": "#f97316",
        "_default": "#307FE2",
        "_exclusivo": "#e11d48"
      };

      // ----- Script Sincronización Modo Oscuro -----
      function aplicarTema() {
          if (localStorage.getItem("tema") === "oscuro") {
              document.body.classList.add("tema-oscuro");
          } else {
              document.body.classList.remove("tema-oscuro");
          }
      }
      aplicarTema(); // Al cargar
      window.addEventListener('storage', function(event) {
          if (event.key === 'tema') {
              aplicarTema(); // Al detectar cambio
          }
      });


      // ----- Datos mock (Igual que el coordinador) -----
      const EVENTS_LS_KEY = "citt_eventos_aprobados";
      const eventosAprobados = JSON.parse(localStorage.getItem(EVENTS_LS_KEY) || "{}");

      const ESTADOS_LS_KEY = "citt_estados_solicitudes";
      const estadosPersistidos = JSON.parse(localStorage.getItem(ESTADOS_LS_KEY) || "{}");

      const eventosMock = [
        {
          id: "e1", title: "Reserva Sala 1 - Taller",
          start: "2025-11-06T10:00:00", end: "2025-11-06T12:00:00",
          espacio: "Sala de reuniones", exclusivo: false, solicitante: "demo@duocuc.cl",
          personas: 10, articulos: ["Proyector"], detalle: "Actividad demo cargada por defecto"
        },
        {
          id: "e2", title: "Cápsula A - Edición",
          start: "2025-11-07T14:00:00", end: "2025-11-07T15:00:00",
          espacio: "Cápsula A", exclusivo: false, solicitante: "demo2@duocuc.cl",
          personas: 3, articulos: ["Micrófono", "Cámara"], detalle: "Prueba de edición en cápsula"
        }
      ];
      
      const solicitudesMock = [
        {
          id: "s1", titulo: "Sala de reuniones", solicitante: "jperez@duocuc.cl",
          fecha: "2025-11-08", inicio: "09:30", fin: "11:00",
          espacio: "Sala de reuniones", detalle: "Reunión proyecto IoT",
          personas: 8, exclusivo: false, articulos: ["Proyector", "Notebook (2)"]
        },
        {
          id: "s2", titulo: "Cápsula A (streaming)", solicitante: "mrojas@duocuc.cl",
          fecha: "2025-11-08", inicio: "12:00", fin: "13:00",
          espacio: "Cápsula A", detalle: "Grabación cápsula Clase 6",
          personas: 3, exclusivo: false, articulos: ["Micrófonos inalámbricos (2)"]
        },
        {
          id: "s3", titulo: "Sitio personal 3", solicitante: "florente@duocuc.cl",
          fecha: "2025-11-09", inicio: "15:00", fin: "17:30",
          espacio: "Sala CIIT completa", detalle: "Prototipo impresión 3D",
          personas: 15, exclusivo: true, articulos: ["Impresora 3D", "Notebook", "Cámara"]
        }
      ].map(s => ({ ...s, estado: estadosPersistidos[s.id] || "pendiente" }));


      // ---------- Lógica Principal (SIN EDICIÓN) ----------
      document.addEventListener("DOMContentLoaded", function() {
        const calendarEl = document.getElementById("calendar");
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 800 ? "timeGridDay" : "timeGridWeek",
          locale: "es",
          buttonText: {
            today: "Hoy",
            timeGridWeek: "Semana",
            timeGridDay:  "Día"
          },
          expandRows: true,
          height: "auto",
          contentHeight: "auto",
          nowIndicator: true,
          slotMinTime: "08:00:00",
          slotMaxTime: "23:00:00",
          allDaySlot: false,
          dayMaxEventRows: 3,
          eventOverlap: false,
          headerToolbar: { left: "prev,next today", center: "title", right: "timeGridWeek,timeGridDay" },
          events: eventosMock,
          eventDidMount: (info) => {
            const { espacio, exclusivo } = info.event.extendedProps || {};
            let color;
            if (exclusivo) {
              color = COLOR_EVENTOS["_exclusivo"];
            } else if (espacio && COLOR_EVENTOS[espacio]) {
              color = COLOR_EVENTOS[espacio];
            } else {
              color = COLOR_EVENTOS["_default"];
            }
            const el = info.el;
            el.style.backgroundColor = color;
            el.style.borderColor = color;
            el.style.color = "#ffffff";
          },
          eventClick: (info) => {
            const ev  = info.event;
            const ext = ev.extendedProps || {};
            if (ext.solicitud) {
              abrirDetalle(ext.solicitud);
              return;
            }
            const start = ev.start;
            const end   = ev.end || ev.start;
            const pad = (n) => String(n).padStart(2, "0");
            const fecha = `${start.getFullYear()}-${pad(start.getMonth() + 1)}-${pad(start.getDate())}`;
            const inicio = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
            const fin = `${pad(end.getHours())}:${pad(end.getMinutes())}`;
            const solFake = {
              titulo: ev.title,
              espacio: ext.espacio || ev.title,
              fecha, inicio, fin,
              solicitante: ext.solicitante || "No indicado",
              personas: ext.personas != null ? ext.personas : "No indicado",
              exclusivo: ext.exclusivo || false,
              articulos: ext.articulos || [],
              detalle: ext.detalle || ""
            };
            abrirDetalle(solFake);
          },
          windowResize: () => {
            calendar.changeView(
              window.innerWidth < 800 ? "timeGridDay" : "timeGridWeek"
             );
          }
        });
        calendar.render();

        // ----- Modal detalle (Funciona igual) -----
        const overlayDetalle   = document.getElementById("overlayDetalle");
        const detalleContenido = document.getElementById("detalleContenido");
        const btnCerrarDetalle = document.getElementById("btnCerrarDetalle");

        const abrirDetalle = (sol) => {
          const exclusividadTexto = sol.exclusivo
            ? "Sí, uso exclusivo de la sala CIIT"
            : "No, solo una sección / espacio específico";
          const articulosTexto = sol.articulos && sol.articulos.length
            ? sol.articulos.join(", ")
            : "Sin artículos asociados";

          detalleContenido.innerHTML = `
            <div class="detalle-grid">
              <div><strong>Espacio</strong><span>${sol.espacio || sol.titulo}</span></div>
              <div><strong>Fecha</strong><span>${sol.fecha}</span></div>
              <div><strong>Horario</strong><span>${sol.inicio} - ${sol.fin}</span></div>
              <div><strong>Solicitante</strong><span>${sol.solicitante}</span></div>
              <div><strong>N° de personas</strong><span>${sol.personas || "No indicado"}</span></div>
              <div><strong>Exclusividad</strong><span>${exclusividadTexto}</span></div>
            </div>
            <div class="detalle-nota">
              <strong>Artículos solicitados:</strong><br/>
              <span>${articulosTexto}</span>
            </div>
            <div class="detalle-nota">
              <strong>Detalle adicional:</strong><br/>
              <span>${sol.detalle || "Sin detalle adicional"}</span>
            </div>
          `;
          overlayDetalle.classList.add("activo");
          overlayDetalle.setAttribute("aria-hidden", "false");
        };

        const cerrarDetalle = () => {
          overlayDetalle.classList.remove("activo");
          overlayDetalle.setAttribute("aria-hidden", "true");
        };
        btnCerrarDetalle.addEventListener("click", cerrarDetalle);
        overlayDetalle.addEventListener("click", (e) => {
          if (e.target === overlayDetalle) cerrarDetalle();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") cerrarDetalle();
        });

        // Cargar eventos aprobados (igual)
        Object.values(eventosAprobados).forEach(evt => calendar.addEvent(evt));


        // ---------- Renderizar solicitudes (SIN ACCIONES) ----------
        const cont = document.getElementById("listaSolicitudes"); // <tbody>

        const renderChip = (estado) => {
          const span = document.createElement("span");
          span.className = `chip ${estado}`;
          span.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
          return span;
        };
        
        solicitudesMock.forEach(sol => {
          const tr = document.createElement("tr");

          const tdEspacio = document.createElement("td");
          tdEspacio.textContent = sol.espacio || sol.titulo;
          const tdFecha = document.createElement("td");
          tdFecha.textContent = sol.fecha;
          const tdHorario = document.createElement("td");
          tdHorario.textContent = `${sol.inicio} - ${sol.fin}`;
          const tdSolicitante = document.createElement("td");
          tdSolicitante.textContent = sol.solicitante;
          const tdDetalle = document.createElement("td");
          tdDetalle.textContent = sol.detalle;
          const tdEstado = document.createElement("td");
          const chip = renderChip(sol.estado);
          tdEstado.appendChild(chip);

          // El clic en la fila se mantiene
          tr.addEventListener("click", () => {
            abrirDetalle(sol);
          });

          tr.appendChild(tdEspacio);
          tr.appendChild(tdFecha);
          tr.appendChild(tdHorario);
          tr.appendChild(tdSolicitante);
          tr.appendChild(tdDetalle);
          tr.appendChild(tdEstado);
          
          cont.appendChild(tr);
        });

      });
    </script>
</body>
</html>